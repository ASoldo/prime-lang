test tests.macros;

macro assert_positive(value: int32) {
  expect(value > 0, "value should stay positive");
}

macro sum_label(a: int32, b: int32) -> int32 {
  out(`sum {a + b}`);
  a + b
}

macro add_item() {
  fn generated_value() -> int32 {
    42
  }
}

~add_item();

macro repeat(expr: tokens) -> int32 {
  expr + expr
}

macro apply_twice(body: block) {
  body;
  body;
}

macro match_literal(pat: pattern, value: int32) -> int32 {
  match value {
    pat => 7,
    _ => 0,
  }
}

macro collect(values: repeat) -> (int32, int32, int32) {
  values
}

fn statement_macro_executes() -> bool {
  ~assert_positive(2);
  true
}

fn statement_macro_runs_inside_loop() -> bool {
  let []int32 values = [
    1,
    2,
    3,
  ];
  let mut int32 total = 0;
  for value in values {
    ~assert_positive(value);
    total = total + value;
  }
  total == 6
}

fn expression_macro_in_statement_context() -> bool {
  let int32 value = ~sum_label(3, 4);
  value == 7
}

macro capture_outer() -> int32 {
  @value + 1
}

fn capture_escape_opt_in() -> bool {
  let int32 value = 5;
  let int32 bumped = ~capture_outer();
  bumped == 6
}

fn item_macro_generates_function() -> bool {
  generated_value() == 42
}

fn tokens_param_inlines_without_binding() -> bool {
  let int32 sum = ~repeat(2 + 3);
  sum == 10
}

fn block_param_runs_multiple_times() -> bool {
  let mut int32 seen = 0;
  ~apply_twice({
  seen = seen + 1;
});
  seen == 2
}

fn pattern_param_expands_into_match() -> bool {
  ~match_literal(0, 0) == 7 && ~match_literal(1, 0) == 0
}

fn repeat_param_expands_tuple() -> bool {
  let (a, b, c) = ~collect(@sep = , 1, 2, 3);
  a == 1 && b == 2 && c == 3
}
