name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  host:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install LLVM 21 (for llvm-sys)
        run: |
          curl -L -o /tmp/llvm.tar.xz https://github.com/llvm/llvm-project/releases/download/llvmorg-21.1.0/clang+llvm-21.1.0-x86_64-linux-gnu-ubuntu-22.04.tar.xz
          sudo mkdir -p /opt/llvm-21
          sudo tar -xf /tmp/llvm.tar.xz -C /opt/llvm-21 --strip-components=1
          echo "LLVM_SYS_211_PREFIX=/opt/llvm-21" >> $GITHUB_ENV
      - name: Build
        run: cargo build --locked
      - name: Test
        run: cargo test --locked

  esp32-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install ESP-IDF toolchain
        uses: espressif/install-esp-idf-action@v1
        with:
          version: v5.2
      - name: Build CLI
        run: cargo build --release --locked
      - name: Smoke build ESP32 blink demo (no flash)
        env:
          PRIME_EMBEDDED_SMOKE: "1"
        run: |
          source $IDF_PATH/export.sh
          ./target/release/prime-lang build workspace/demos/esp32_blink/esp32_blink.prime --name ci-esp32 --no-flash
