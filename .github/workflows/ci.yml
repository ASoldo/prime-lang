name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  host:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install LLVM 21 (for llvm-sys)
        run: |
          sudo apt-get update
          sudo apt-get install -y wget lsb-release software-properties-common
          wget https://apt.llvm.org/llvm.sh
          chmod +x llvm.sh
          sudo ./llvm.sh 21
          echo "LLVM_SYS_211_PREFIX=/usr/lib/llvm-21" >> $GITHUB_ENV
      - name: Build
        run: cargo build --locked
      - name: Test
        run: cargo test --locked

  esp32-smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install ESP-IDF toolchain
        uses: espressif/install-esp-idf-action@v1
        with:
          version: v5.2
      - name: Build CLI
        run: cargo build --release --locked
      - name: Smoke build ESP32 blink demo (no flash)
        env:
          PRIME_EMBEDDED_SMOKE: "1"
        run: |
          source $IDF_PATH/export.sh
          ./target/release/prime-lang build workspace/demos/esp32_blink/esp32_blink.prime --name ci-esp32 --no-flash
